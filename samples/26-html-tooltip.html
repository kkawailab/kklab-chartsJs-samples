<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- 文字エンコーディングをUTF-8に設定 -->
    <meta charset="UTF-8">
    <!-- レスポンシブデザイン用のビューポート設定 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26 - HTML カスタムツールチップ</title>
    <!-- Chart.js ライブラリをCDNから読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ===== CSSリセット ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ===== ページ全体のスタイル ===== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        /* ===== メインコンテナ ===== */
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        /* チャートとツールチップを含むラッパー */
        .chart-wrapper {
            position: relative;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        /* ===== カスタムHTMLツールチップのスタイル ===== */
        #tooltip {
            position: absolute;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 15px;
            /* マウスイベントを透過（ツールチップがマウス操作を妨げない） */
            pointer-events: none;
            /* 初期状態は非表示 */
            opacity: 0;
            /* フェードイン・アウトのアニメーション */
            transition: opacity 0.2s ease;
            z-index: 100;
            min-width: 200px;
        }

        /* アクティブ時は表示 */
        #tooltip.active {
            opacity: 1;
        }

        /* ツールチップのヘッダー */
        .tooltip-header {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        /* ツールチップの各行 */
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }

        .tooltip-label {
            color: #666;
        }

        .tooltip-value {
            font-weight: bold;
            color: #333;
        }

        /* バッジスタイル */
        .tooltip-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 8px;
        }

        .badge-up {
            background: #d4edda;
            color: #155724;
        }

        .badge-down {
            background: #f8d7da;
            color: #721c24;
        }

        .description {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>26 - HTML カスタムツールチップ</h1>

        <!-- チャートとカスタムツールチップのラッパー -->
        <div class="chart-wrapper">
            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>
            <!-- カスタムHTMLツールチップ -->
            <div id="tooltip"></div>
        </div>

        <div class="description">
            <strong>学習ポイント:</strong>
            <ul>
                <li>tooltip.enabled: false でデフォルトツールチップを無効化</li>
                <li>tooltip.external でカスタムHTMLツールチップを実装</li>
                <li>HTMLでリッチなコンテンツを表示</li>
                <li>CSSでツールチップのスタイルを自由にカスタマイズ</li>
            </ul>
        </div>
    </div>

    <script>
        // ===== HTMLカスタムツールチップ =====
        // デフォルトのCanvasツールチップの代わりに
        // HTML要素を使用してリッチなツールチップを作成

        // canvas要素の2Dコンテキストを取得
        const ctx = document.getElementById('myChart').getContext('2d');

        // 詳細データ（ツールチップで表示）
        // チャートのdataとは別に、追加情報を持つ配列を用意
        const salesData = [
            { month: '1月', sales: 120, target: 100, lastYear: 90, growth: 33 },
            { month: '2月', sales: 150, target: 130, lastYear: 110, growth: 36 },
            { month: '3月', sales: 180, target: 160, lastYear: 140, growth: 29 },
            { month: '4月', sales: 170, target: 180, lastYear: 165, growth: 3 },
            { month: '5月', sales: 200, target: 190, lastYear: 180, growth: 11 },
            { month: '6月', sales: 230, target: 210, lastYear: 195, growth: 18 }
        ];

        // ★ カスタムツールチップハンドラー
        // この関数がツールチップの表示・非表示・内容を制御
        const externalTooltipHandler = (context) => {
            // context.chart: Chartインスタンス
            // context.tooltip: ツールチップの情報
            const { chart, tooltip } = context;
            const tooltipEl = document.getElementById('tooltip');

            // ★ tooltip.opacity === 0 の場合、ツールチップを非表示
            if (tooltip.opacity === 0) {
                tooltipEl.classList.remove('active');
                return;
            }

            // ★ ツールチップの内容を生成
            if (tooltip.body) {
                // tooltip.dataPoints[0].dataIndex で現在のデータインデックスを取得
                const dataIndex = tooltip.dataPoints[0].dataIndex;
                const data = salesData[dataIndex];

                // 成長率に応じてバッジを生成
                const growthBadge = data.growth >= 20
                    ? `<span class="tooltip-badge badge-up">+${data.growth}% 好調</span>`
                    : data.growth < 10
                    ? `<span class="tooltip-badge badge-down">+${data.growth}% 要注意</span>`
                    : `<span class="tooltip-badge badge-up">+${data.growth}%</span>`;

                // 達成率を計算
                const achievementRate = Math.round((data.sales / data.target) * 100);

                // ★ HTML内容を生成
                tooltipEl.innerHTML = `
                    <div class="tooltip-header">${data.month}の実績</div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">売上</span>
                        <span class="tooltip-value">${data.sales}万円</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">目標</span>
                        <span class="tooltip-value">${data.target}万円</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">達成率</span>
                        <span class="tooltip-value">${achievementRate}%</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">前年同月</span>
                        <span class="tooltip-value">${data.lastYear}万円</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">前年比</span>
                        ${growthBadge}
                    </div>
                `;
            }

            // ★ ツールチップの位置を設定
            // chart.canvas.offsetLeft/Top: キャンバスの位置
            // tooltip.caretX/Y: ツールチップを表示すべき位置
            const { offsetLeft: positionX, offsetTop: positionY } = chart.canvas;

            tooltipEl.style.left = positionX + tooltip.caretX + 'px';
            tooltipEl.style.top = positionY + tooltip.caretY + 'px';
            tooltipEl.classList.add('active');
        };

        // チャートのデータ定義
        const data = {
            labels: salesData.map(d => d.month),
            datasets: [{
                label: '売上',
                data: salesData.map(d => d.sales),
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                borderRadius: 5
            }]
        };

        // チャートの設定
        const config = {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,

                interaction: {
                    mode: 'index',
                    intersect: false
                },

                plugins: {
                    title: {
                        display: true,
                        text: '月別売上（HTMLツールチップ）'
                    },

                    // ★ tooltip: カスタムツールチップの設定
                    tooltip: {
                        // enabled: false でデフォルトツールチップを無効化
                        enabled: false,
                        // external: カスタムツールチップハンドラーを指定
                        external: externalTooltipHandler
                    }
                },

                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        // チャートを描画
        new Chart(ctx, config);
    </script>
</body>
</html>
